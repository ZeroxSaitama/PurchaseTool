<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>Stryke.xyz - Earn</title>
    <!-- Import Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tippy.js for enhanced tooltips -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/shift-away.css" />
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              primary: '#FBBF24', // yellow-500
            },
            backgroundImage: {
              'hero-light': 'linear-gradient(135deg, rgba(255,255,255,0.9), rgba(243,244,246,0.9))',
              'hero-dark': 'linear-gradient(135deg, rgba(31,41,55,0.9), rgba(55,65,81,0.9))',
            },
            boxShadow: {
              'card': '0 4px 6px rgba(0,0,0,0.1)',
              'float': '0 10px 15px rgba(0,0,0,0.1)',
            },
          }
        }
      }
    </script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <!-- Sidebar & Main Layout -->
    <div class="min-h-screen flex">
      <!-- Sidebar -->
      <aside class="w-64 bg-white dark:bg-gray-800 shadow-lg">
        <div class="p-6">
          <!-- Replace with your logo icon if available -->
          <img src="https://i.ibb.co/FLF1CX6D/Logomark-White-Transparent.png" alt="Logo" class="inline-block mr-2 rounded-full shadow-sm" />
        </div>
        <nav class="mt-6">
          <a href="trade.html" class="block px-6 py-3 text-lg font-medium hover:bg-yellow-100 dark:hover:bg-gray-700 transition">Trade</a>
          <a href="earn.html" class="block px-6 py-3 text-lg font-medium text-yellow-500 dark:text-yellow-400 border-l-4 border-yellow-500">Earn</a>
          <!-- More nav items here -->
        </nav>
      </aside>
      
      <!-- Main Content -->
      <main class="flex-1 p-6">
        <!-- Navbar Top (for mobile view if needed) -->
        <div class="flex justify-between items-center mb-4 sm:hidden">
          <h1 class="text-2xl font-bold">Earn</h1>
          <button id="modeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 transition transform hover:scale-105">
            <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-9H21m-16 0H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 8a4 4 0 110 8 4 4 0 010-8z" />
            </svg>
            <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
            </svg>
          </button>
        </div>
        
        <!-- Hero Banner -->
        <section class="mb-6 p-8 rounded-lg shadow-lg bg-hero-light dark:bg-hero-dark relative overflow-hidden">
          <div class="absolute inset-0 bg-black opacity-20"></div>
          <div class="relative z-10">
            <h1 class="text-4xl sm:text-5xl font-bold mb-2">Stryke.xyz</h1>
            <p class="text-xl sm:text-2xl text-gray-700 dark:text-gray-300">Worry Free No Liquidation Leverage</p>
          </div>
        </section>
        
        <!-- Filters & Toggle Card -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
          <!-- Filters Row -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
            <div>
              <label for="chainFilter" class="block text-sm font-medium">Chain</label>
              <select id="chainFilter" class="mt-1 block w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring focus:ring-yellow-500 transition">
                <option value="146">Sonic</option>
                <option value="42161">Arbitrum</option>
              </select>
            </div>
            <div>
              <label for="dexFilter" class="block text-sm font-medium">DEX</label>
              <select id="dexFilter" class="mt-1 block w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring focus:ring-yellow-500 transition">
                <option value="shadow">Shadow</option>
              </select>
            </div>
            <div>
              <label for="poolSearch" class="block text-sm font-medium">Search Pool</label>
              <input type="text" id="poolSearch" placeholder="Enter pool name" class="mt-1 block w-full rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring focus:ring-yellow-500 transition" />
            </div>
          </div>
          <!-- Strategy Dropdown -->
          <div class="mb-4">
            <label for="strategyDropdown" class="block text-sm font-medium">Strategy</label>
            <select id="strategyDropdown" class="mt-1 w-48 rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring focus:ring-yellow-500 transition">
              <option value="passive">Passive</option>
              <option value="wide">Wide</option>
              <option value="narrow">Narrow</option>
              <option value="aggressive">Aggressive</option>
              <option value="insane">Insane</option>
            </select>
          </div>
          <!-- Metrics Toggle -->
          <div class="flex justify-center mb-4">
            <div class="inline-flex rounded-md shadow" role="group">
              <button type="button" id="toggleStryke" class="px-4 py-2 rounded-l transition bg-yellow-500 text-black font-medium">Stryke Metrics</button>
              <button type="button" id="toggleDex" class="px-4 py-2 rounded-r transition bg-gray-300 dark:bg-gray-600 text-black font-medium">DEX Metrics</button>
            </div>
          </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="flex justify-between mb-6">
          <div class="text-left">
            <h5 class="text-xl font-semibold">Total TVL: <span id="totalTVL">-</span></h5>
          </div>
          <div class="text-right">
            <h5 class="text-xl font-semibold">Total 24h Volume: <span id="totalVolume">-</span></h5>
          </div>
        </div>
        
        <!-- Refresh Indicator & Skeleton Loader -->
        <div id="loadingIndicator" class="flex items-center justify-center py-4 hidden">
          <svg class="animate-spin h-6 w-6 text-yellow-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
          </svg>
          <span class="text-lg font-medium">Updating...</span>
        </div>
        
        <!-- Pools Table -->
        <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg">
          <table id="poolsTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Pool</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">TVL of Options</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">APR</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Rewards</th>
                <th class="px-4 py-3 text-left text-sm font-semibold uppercase tracking-wider">Implied Daily Move</th>
              </tr>
            </thead>
            <tbody id="poolsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
              <!-- Table rows will be injected here -->
            </tbody>
          </table>
        </div>
      </main>
    </div>
    
    <!-- JavaScript -->
    <script>
      let currentMetrics = "stryke"; // "stryke" or "dex"
      
      // Dark/Light Mode Toggle with smooth rotation.
      const modeToggle = document.getElementById('modeToggle');
      modeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        // Animate the toggle icon.
        modeToggle.classList.toggle('rotate-180');
      });
      
      // Market configuration.
      const marketConfig = {
        "146": {
          wS: {
            optionMarket: "0x342e4068bA07bbCcBDDE503b2451FAa3D3C0278B",
            spotApi: "https://api.stryke.xyz/uniswap-prices/mark-price?chainId=146&ticker=WS/USDC.e"
          },
          WETH: {
            optionMarket: "0xYourWETHOptionMarketFor146", // update as needed
            spotApi: "https://api.stryke.xyz/uniswap-prices/mark-price?chainId=146&ticker=WETH/USDC.e"
          }
        },
        "42161": {
          WETH: {
            optionMarket: "0xArbitrumOptionMarketForWETH", // update with actual address
            spotApi: "https://api.stryke.xyz/uniswap-prices/mark-price?chainId=42161&ticker=WETH/USDC.e"
          },
          wS: {
            optionMarket: "0xArbitrumOptionMarketForWS", // update if applicable
            spotApi: "https://api.stryke.xyz/uniswap-prices/mark-price?chainId=42161&ticker=WS/USDC.e"
          }
        }
      };
      
      // Fetch StrykeLP data.
      async function fetchStrykeLPData() {
        const url = "https://api.stryke.xyz/v1.1/clamm/option-markets?chains=42161%2C146%2C8453%2C81457%2C5000%2C80094";
        const response = await fetch(url);
        const data = await response.json();
        return data.filter(pool => !pool.deprecated && (pool.chainId === 146 || pool.chainId === 42161));
      }
      
      // Fetch Shadow data.
      async function fetchShadowData() {
        const url = "https://api.shadow.so/mixed-pairs";
        const response = await fetch(url);
        const rawShadow = await response.json();
        return rawShadow.pairs;
      }
      
      function formatNumber(num) {
        if (!num || isNaN(num)) return "N/A";
        return parseFloat(num).toLocaleString(undefined, { maximumFractionDigits: 2 });
      }
      
      // Token matching.
      function tokensMatch(strykePool, shadowPool) {
        const callAddr = strykePool.callToken.address.toLowerCase();
        const putAddr = strykePool.putToken.address.toLowerCase();
        const token0 = shadowPool.token0.toLowerCase();
        const token1 = shadowPool.token1.toLowerCase();
        return (callAddr === token0 && putAddr === token1) ||
               (callAddr === token1 && putAddr === token0);
      }
      
      // Choose best Shadow pool (highest TVL).
      function chooseBestShadowPool(strykePool, shadowPools) {
        const matches = shadowPools.filter(sh => tokensMatch(strykePool, sh));
        if (matches.length === 0) return null;
        return matches.reduce((max, cur) => {
          const maxTVL = max.tvl ? parseFloat(max.tvl) : 0;
          const curTVL = cur.tvl ? parseFloat(cur.tvl) : 0;
          return (curTVL > maxTVL) ? cur : max;
        });
      }
      
      // Fetch spot price.
      async function fetchSpotPrice(url) {
        const response = await fetch(url);
        const data = await response.json();
        return parseFloat(data.markPrice);
      }
      
      // Fetch ATM premium (premium + fees).
      async function fetchAtmPremium(chainId, optionMarket, spotPrice, ttl) {
        const userAddress = "0xf8859BAae87Eac4C7EE0b81499eDDD99c778FBEB";
        const url = `https://api.stryke.xyz/clamm/purchase/quote?chainId=${chainId}&optionMarket=${optionMarket}&user=${userAddress}&strike=${spotPrice}&markPrice=${spotPrice}&type=call&amount=1&ttl=${ttl}`;
        const response = await fetch(url);
        const data = await response.json();
        const decimals = data.token.decimals;
        return (parseFloat(data.premium) + parseFloat(data.fees || 0)) / Math.pow(10, decimals);
      }
      
      async function loadEarnPage() {
        // Show loading indicator
        document.getElementById('loadingIndicator').classList.remove('hidden');
        
        const chainSelect = parseInt(document.getElementById('chainFilter').value);
        const dexSelect = document.getElementById('dexFilter').value.toLowerCase();
        const searchQuery = document.getElementById('poolSearch').value.toLowerCase();
        const strategy = document.getElementById('strategyDropdown').value.toLowerCase();
        
        if (dexSelect !== "shadow") {
          document.getElementById('poolsTableBody').innerHTML = "";
          document.getElementById('totalTVL').innerText = "-";
          document.getElementById('totalVolume').innerText = "-";
          document.getElementById('loadingIndicator').classList.add('hidden');
          return;
        }
        
        const [strykeData, shadowData] = await Promise.all([
          fetchStrykeLPData(),
          fetchShadowData()
        ]);
        console.log("Stryke raw data:", strykeData);
        console.log("Shadow raw data (pairs):", shadowData);
        
        let pools = strykeData.filter(pool => pool.chainId === chainSelect);
        if (searchQuery) {
          pools = pools.filter(pool =>
            pool.ticker.toLowerCase().includes(searchQuery) ||
            pool.pairName.toLowerCase().includes(searchQuery)
          );
        }
        
        let matchedPools = [];
        pools.forEach(strykePool => {
          const bestShadow = chooseBestShadowPool(strykePool, shadowData);
          if (bestShadow) {
            matchedPools.push({ stryke: strykePool, shadow: bestShadow });
          }
        });
        console.log("matchedPools:", matchedPools);
        
        let totalTVL = 0, totalVol = 0;
        matchedPools.forEach(mp => {
          totalTVL += (mp.stryke.totalLiquidity || 0);
          totalVol += (mp.stryke.volume24h || 0);
        });
        document.getElementById('totalTVL').innerText = formatNumber(totalTVL);
        document.getElementById('totalVolume').innerText = formatNumber(totalVol);
        
        const tableRows = await Promise.all(matchedPools.map(async mp => {
          let ticker = mp.stryke.ticker.toLowerCase();
          let marketType = ticker.includes("weth") ? "WETH" : "wS";
          const poolMarketConfig = marketConfig[chainSelect.toString()][marketType] || marketConfig[chainSelect.toString()].wS;
          let spotPrice = await fetchSpotPrice(poolMarketConfig.spotApi);
          let optionMarketAddress = mp.stryke.address;
          let totalCostDaily = await fetchAtmPremium(chainSelect, optionMarketAddress, spotPrice, 86400);
          let utilApr100 = (totalCostDaily * 365 * 100).toFixed(2);
          let impliedDaily = (totalCostDaily * 100).toFixed(2);
          
          let selectedRange = (mp.shadow.recommendedRangesNew && Array.isArray(mp.shadow.recommendedRangesNew))
            ? mp.shadow.recommendedRangesNew.find(range => range.name.toLowerCase() === strategy)
            : null;
          let utilApr0 = selectedRange 
            ? parseFloat(selectedRange.rewardApr).toFixed(2)
            : (mp.shadow.lpApr ? parseFloat(mp.shadow.lpApr).toFixed(2) : "0.00");
          
          let displayedTVL, tvlTooltip, displayedAPR, aprTooltip;
          if (currentMetrics === "stryke") {
            displayedTVL = formatNumber(mp.stryke.totalLiquidity);
            tvlTooltip = "Stryke TVL: " + formatNumber(mp.stryke.totalLiquidity) + "<br>DEX TVL: " + formatNumber(mp.shadow.totalValueLockedUSD ? parseFloat(mp.shadow.totalValueLockedUSD) : (mp.shadow.tvl ? parseFloat(mp.shadow.tvl) : 0));
            displayedAPR = utilApr100;
            aprTooltip = "0% Util APR: " + utilApr0 + "%<br>100% Util APR: " + utilApr100 + "%";
          } else {
            displayedTVL = formatNumber(mp.shadow.totalValueLockedUSD ? parseFloat(mp.shadow.totalValueLockedUSD) : (mp.shadow.tvl ? parseFloat(mp.shadow.tvl) : 0));
            tvlTooltip = "DEX TVL: " + displayedTVL + "<br>Stryke TVL: " + formatNumber(mp.stryke.totalLiquidity);
            displayedAPR = utilApr0;
            aprTooltip = "0% Util APR: " + utilApr0 + "%<br>100% Util APR: " + utilApr100 + "%";
          }
          
          let assetIcon = ticker.includes("weth")
            ? '<img src="https://via.placeholder.com/24/0000FF/FFFFFF?text=W" alt="WETH" class="inline-block mr-2 rounded-full shadow-sm" />'
            : '<img src="https://via.placeholder.com/24/FF0000/FFFFFF?text=WS" alt="WS" class="inline-block mr-2 rounded-full shadow-sm" />';
          
          let rewardsText = marketType === "weth" ? "4–8x Sonic Points<br>1x Gem Points" : "4–8x Sonic Points<br>2x Gem Points";
          
          return {
            poolName: assetIcon + mp.stryke.ticker,
            displayedTVL: displayedTVL,
            tvlTooltip: tvlTooltip,
            displayedAPR: displayedAPR,
            aprTooltip: aprTooltip,
            rewardsText: rewardsText,
            impliedDaily: impliedDaily
          };
        }));
        
        const tbody = document.getElementById('poolsTableBody');
        tbody.innerHTML = "";
        tableRows.forEach(row => {
          const tr = document.createElement('tr');
          tr.classList.add("hover:bg-gray-100", "dark:hover:bg-gray-800", "transition-colors", "duration-200");
          tr.innerHTML = `
            <td class="px-4 py-2">${row.poolName}</td>
            <td class="px-4 py-2" data-tippy-content="${row.tvlTooltip}">
              ${row.displayedTVL}
            </td>
            <td class="px-4 py-2" data-tippy-content="${row.aprTooltip}">
              ${row.displayedAPR}%
            </td>
            <td class="px-4 py-2" data-tippy-content="${row.rewardsText}">
              ♦
            </td>
            <td class="px-4 py-2" data-tippy-content="Implied Daily Move: ${row.impliedDaily}%">
              ${row.impliedDaily}%
            </td>
          `;
          tbody.appendChild(tr);
        });
        
        // Initialize Tippy.js tooltips.
        setTimeout(() => {
          tippy('[data-tippy-content]', { theme: 'light-border', animation: 'shift-away', delay: [100, 100] });
          // Hide loading indicator.
          document.getElementById('loadingIndicator').classList.add('hidden');
        }, 150);
      }
      
      // Toggle controls.
      document.getElementById('toggleStryke').addEventListener('click', () => {
        currentMetrics = "stryke";
        document.getElementById('toggleStryke').classList.add("bg-yellow-500", "text-black");
        document.getElementById('toggleStryke').classList.remove("bg-gray-300", "dark:bg-gray-600");
        document.getElementById('toggleDex').classList.add("bg-gray-300", "dark:bg-gray-600");
        document.getElementById('toggleDex').classList.remove("bg-yellow-500", "text-black");
        loadEarnPage();
      });
      document.getElementById('toggleDex').addEventListener('click', () => {
        currentMetrics = "dex";
        document.getElementById('toggleDex').classList.add("bg-yellow-500", "text-black");
        document.getElementById('toggleDex').classList.remove("bg-gray-300", "dark:bg-gray-600");
        document.getElementById('toggleStryke').classList.add("bg-gray-300", "dark:bg-gray-600");
        document.getElementById('toggleStryke').classList.remove("bg-yellow-500", "text-black");
        loadEarnPage();
      });
      
      document.getElementById('chainFilter').addEventListener('change', loadEarnPage);
      document.getElementById('poolSearch').addEventListener('input', loadEarnPage);
      document.getElementById('dexFilter').addEventListener('change', loadEarnPage);
      document.getElementById('strategyDropdown').addEventListener('change', loadEarnPage);
      
      // Show skeleton loader before data loads.
      function showSkeleton() {
        const tbody = document.getElementById('poolsTableBody');
        tbody.innerHTML = "";
        for (let i = 0; i < 5; i++) {
          const tr = document.createElement('tr');
          tr.classList.add("animate-pulse");
          tr.innerHTML = `
            <td class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded"></td>
            <td class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded"></td>
            <td class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded"></td>
            <td class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded"></td>
            <td class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded"></td>
          `;
          tbody.appendChild(tr);
        }
      }
      
      // Show loading indicator.
      const loadingIndicator = document.createElement('div');
      loadingIndicator.id = "loadingIndicator";
      loadingIndicator.className = "flex items-center justify-center py-4";
      loadingIndicator.innerHTML = `
        <svg class="animate-spin h-6 w-6 text-yellow-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
        </svg>
        <span class="text-lg font-medium">Updating...</span>
      `;
      // Append loading indicator above the table.
      document.querySelector("#poolsTable").parentElement.insertBefore(loadingIndicator, document.querySelector("#poolsTable"));
      loadingIndicator.classList.add('hidden');
      
      // Initial load.
      loadEarnPage();
    </script>
  </body>
</html>
